<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Newsletter Admin Panel</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: white;
        min-height: 100vh;
        color: #333;
      }

      .container {
        width: 100%;
        margin: 0 auto;
        background: white;
        min-height: 100vh;
      }

      .header {
        padding: 30px;
        border-radius: 20px;
        border-bottom: 2px solid black;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }

      .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }

      .nav-tab:hover {
        background: #e9ecef;
        color: #495057;
      }

      .nav-tab.active {
        background: white;
        color: #4caf50;
        border-bottom-color: #4caf50;
      }

      .tab-content {
        display: none;
        padding: 40px;
        animation: fadeIn 0.3s ease;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section {
        margin-bottom: 40px;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 1px solid #e9ecef;
      }

      .section-title {
        font-size: 1.5rem;
        color: #2c3e50;
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: "";
        width: 4px;
        height: 25px;
        background: #4caf50;
        border-radius: 2px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      .form-control:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      textarea.form-control {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #4caf50;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #6c757d;
        font-weight: 600;
      }

      .subscriber-list {
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        background: white;
      }

      .subscriber-controls {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .subscriber-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .subscriber-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }

      .subscriber-checkbox {
        margin-right: 15px;
        transform: scale(1.2);
      }

      .subscriber-email {
        flex: 1;
        font-weight: 500;
        color: #495057;
      }

      .subscriber-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .subscriber-date {
        color: #6c757d;
        font-size: 0.85rem;
      }

      .subscriber-source {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #495057;
      }

      .status-message {
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        border: 2px solid;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }

      .status-info {
        background: #cce7ff;
        color: #004085;
        border-color: #b8d4f0;
      }

      .send-section {
        background: #4caf50;
        color: white;
        text-align: center;
        padding: 40px;
        border-radius: 15px;
      }

      .send-btn {
        background: white;
        color: #4caf50;
        padding: 15px 40px;
        border: none;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .send-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .history-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #e9ecef;
        margin-top: 20px;
      }

      .history-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
      }

      .history-table td {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
      }

      .history-table tr:hover {
        background: #f8f9fa;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      .attachment-container {
        border: 2px dashed #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
      }

      .attachment-container:hover {
        border-color: #667eea;
        background: #f0f2ff;
      }

      .attachment-info {
        margin-top: 10px;
        color: #6c757d;
      }

      .attachment-list {
        margin-top: 15px;
        text-align: left;
      }

      .attachment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        margin: 5px 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        font-size: 14px;
      }

      .attachment-name {
        display: flex;
        align-items: center;
        flex-grow: 1;
      }

      .attachment-size {
        color: #6c757d;
        font-size: 12px;
        margin-left: 10px;
      }

      .attachment-remove {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
      }

      .attachment-remove:hover {
        background: #c82333;
      }

      .file-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .tab-content {
          padding: 20px;
        }

        .subscriber-controls {
          flex-direction: column;
        }

        .header h1 {
          font-size: 2rem;
        }

        .nav-tabs {
          flex-direction: column;
        }

        .subscriber-meta {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>S2K Sewing - Newsletter Champaign</h1>
        <p>Compose, send, and manage your newsletter campaigns</p>
      </div>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('compose')">
          Compose
        </button>
        <button class="nav-tab" onclick="switchTab('subscribers')">
          Subscribers
        </button>
        <button class="nav-tab" onclick="switchTab('history')">History</button>
      </div>

      <!-- Compose Tab -->
      <div id="compose" class="tab-content active">
        <!-- Stats Overview -->
        <div class="stats-grid" style="display: none">
          <div class="stat-card">
            <div class="stat-number" id="totalSubscribers">-</div>
            <div class="stat-label">Total Subscribers</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="selectedCount">0</div>
            <div class="stat-label">Selected Recipients</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="newslettersSent">-</div>
            <div class="stat-label">Newsletters Sent</div>
          </div>
        </div>

        <!-- Compose Newsletter Section -->
        <div class="section">
          <h2 class="section-title">Compose Newsletter</h2>

          <div class="form-group">
            <label for="emailSubject">Subject Line *</label>
            <input
              type="text"
              id="emailSubject"
              class="form-control"
              placeholder="Enter an engaging subject line..."
              required
            />
          </div>

          <div class="form-group">
            <label for="emailBody">Newsletter Content *</label>
            <textarea
              id="emailBody"
              class="form-control"
              placeholder="Write your newsletter content here. You can use plain text or basic HTML formatting..."
              rows="12"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label for="emailAttachments">Attachments (Optional)</label>
            <div class="attachment-container">
              <input
                type="file"
                id="emailAttachments"
                class="form-control"
                multiple
                accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"
                onchange="handleAttachments(this)"
              />
              <div class="attachment-info">
                <small
                  >Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (Max
                  5MB per file)</small
                >
              </div>
              <div id="attachmentList" class="attachment-list"></div>
            </div>
          </div>

          <div class="form-group">
            <label>Email Preview</label>
            <div
              id="emailPreview"
              style="
                border: 2px solid #e9ecef;
                border-radius: 10px;
                padding: 20px;
                background: white;
                min-height: 100px;
                color: #6c757d;
              "
            >
              Start typing your newsletter content to see a preview...
            </div>
          </div>
        </div>

        <!-- Quick Recipient Selection -->
        <div class="section">
          <h2 class="section-title">Recipients</h2>

          <div class="subscriber-controls">
            <button class="btn btn-success" onclick="selectAll()">
              Select All
            </button>
            <button class="btn btn-secondary" onclick="deselectAll()">
              Clear Selection
            </button>
          </div>

          <div id="composeSubscriberList" class="subscriber-list">
            <div class="loading">Loading recipients...</div>
          </div>
        </div>

        <!-- Send Section -->
        <div class="send-section">
          <h2 style="margin-bottom: 20px">Ready to Send?</h2>
          <p style="margin-bottom: 30px; opacity: 0.9">
            Review your newsletter and selected recipients before sending
          </p>
          <button class="send-btn" onclick="sendNewsletter()">
            Send Newsletter
          </button>
          <div id="sendStatus"></div>
        </div>
      </div>

      <!-- Subscribers Tab -->
      <div id="subscribers" class="tab-content">
        <div class="section">
          <h2 class="section-title">Subscriber Management</h2>

          <div class="subscriber-controls">
            <button class="btn btn-primary" onclick="loadSubscribers()">
              Refresh Subscribers
            </button>
            <button class="btn btn-success" onclick="exportSubscribers()">
              Export CSV
            </button>
          </div>

          <div id="subscriberList" class="subscriber-list">
            <div class="loading">Loading subscribers...</div>
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">Add Subscriber Manually</h2>
          <div class="form-group">
            <label for="newEmail">Email Address</label>
            <input
              type="email"
              id="newEmail"
              class="form-control"
              placeholder="Enter email address..."
            />
          </div>
          <button class="btn btn-success" onclick="addSubscriber()">
            Add Subscriber
          </button>
          <div id="addSubscriberStatus"></div>
        </div>
      </div>

      <!-- History Tab -->
      <div id="history" class="tab-content">
        <div class="section">
          <h2 class="section-title">Newsletter History</h2>

          <div id="historyContainer">
            <div class="loading">Loading newsletter history...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Newsletter Manager - Complete JavaScript Implementation
      // Global variables
      let subscribers = [];
      let newsletterHistory = [];
      let attachedFiles = [];

      // Configuration - Update this with your actual web app URL
      let WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycby8Q3vXvFGC8tBVc3RsNc71a0DKlTtLl2FhW-FPOKj5uF-L1ILJeoczy7-bZg51wNET/exec";

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        // Load all content on page load
        loadSubscribers();
        loadHistory();

        // Setup email preview
        document
          .getElementById("emailBody")
          .addEventListener("input", updateEmailPreview);
        document
          .getElementById("emailSubject")
          .addEventListener("input", updateEmailPreview);

        // Set initial newsletter count
        document.getElementById("newslettersSent").textContent = "0";
        setupAutoSave();
        loadDraft();

        // Initialize enhanced features
        setTimeout(() => {
          addTemplateButtons();
          addCharacterCounts();
          addSubscriberSearch();
          initializeDragAndDrop();
        }, 500);
      });

      // ==================== TAB SWITCHING ====================
      function switchTab(tabName) {
        // Hide all tabs and remove active class
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab and add active class
        document.getElementById(tabName).classList.add("active");
        document
          .querySelector(`[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
      }

      // ==================== EMAIL PREVIEW ====================
      function updateEmailPreview() {
        const subject = document.getElementById("emailSubject").value;
        const body = document.getElementById("emailBody").value;
        const preview = document.getElementById("emailPreview");

        if (!subject && !body) {
          preview.innerHTML =
            '<em style="color: #6c757d;">Start typing your newsletter content to see a preview...</em>';
          return;
        }

        let previewHtml = "";
        if (subject) {
          previewHtml += `<div style="font-weight: bold; font-size: 1.2em; margin-bottom: 15px; color: #2c3e50;">Subject: ${subject}</div>`;
        }
        if (body) {
          previewHtml += `<div style="line-height: 1.6;">${body.replace(
            /\n/g,
            "<br>"
          )}</div>`;
        }

        // Show attachment info in preview
        if (attachedFiles.length > 0) {
          previewHtml += `<div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
      <strong>📎 Attachments (${attachedFiles.length}):</strong><br>
      ${attachedFiles
        .map((file) => `• ${file.name} (${formatFileSize(file.size)})`)
        .join("<br>")}
    </div>`;
        }

        preview.innerHTML =
          previewHtml ||
          '<em style="color: #6c757d;">No content to preview</em>';
      }

      // ==================== SUBSCRIBER MANAGEMENT ====================
      async function loadSubscribers() {
        try {
          showStatus("Loading subscribers...", "info", "general");

          const response = await fetch(`${WEB_APP_URL}?sheet=Newsletter`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.success === false) {
            throw new Error(data.message || "Unknown error");
          }

          subscribers = Array.isArray(data) ? data : [];
          displaySubscribers();
          displaySubscribersForCompose();
          updateStats();

          showStatus(
            `Loaded ${subscribers.length} subscribers`,
            "success",
            "general"
          );
        } catch (error) {
          console.error("Error loading subscribers:", error);
          showStatus(
            `Error loading subscribers: ${error.message}. Please check your web app URL and permissions.`,
            "error",
            "general"
          );
          subscribers = [];
          displaySubscribers();
          displaySubscribersForCompose();
        }
      }

      function displaySubscribers() {
        const listContainer = document.getElementById("subscriberList");

        if (subscribers.length === 0) {
          listContainer.innerHTML =
            '<div style="text-align: center; color: #6c757d; padding: 40px;">No subscribers found. Add some subscribers to get started!</div>';
          return;
        }

        listContainer.innerHTML = "";

        subscribers.forEach((subscriber, index) => {
          const item = document.createElement("div");
          item.className = "subscriber-item";

          const email = subscriber.email || subscriber.Email || "Unknown";
          const date = subscriber.Date
            ? new Date(subscriber.Date).toLocaleDateString()
            : "N/A";
          const source = subscriber.Source || subscriber.source || "website";

          item.innerHTML = `
      <div class="subscriber-email">${email}</div>
      <div class="subscriber-meta">
        <div class="subscriber-date">Joined: ${date}</div>
        <div class="subscriber-source">${source}</div>
      </div>
    `;

          listContainer.appendChild(item);
        });
      }

      function displaySubscribersForCompose() {
        const listContainer = document.getElementById("composeSubscriberList");

        if (subscribers.length === 0) {
          listContainer.innerHTML =
            '<div style="text-align: center; color: #6c757d; padding: 40px;">No subscribers found</div>';
          return;
        }

        listContainer.innerHTML = "";

        subscribers.forEach((subscriber, index) => {
          const item = document.createElement("div");
          item.className = "subscriber-item";

          const email = subscriber.email || subscriber.Email || "Unknown";
          const date = subscriber.Date
            ? new Date(subscriber.Date).toLocaleDateString()
            : "N/A";
          const source = subscriber.Source || subscriber.source || "website";

          item.innerHTML = `
      <input type="checkbox" class="subscriber-checkbox" id="sub_${index}" 
             onchange="updateSelectedCount()">
      <label for="sub_${index}" class="subscriber-email">${email}</label>
      <div class="subscriber-meta">
        <div class="subscriber-date">${date}</div>
        <div class="subscriber-source">${source}</div>
      </div>
    `;

          listContainer.appendChild(item);
        });
      }

      async function addSubscriber() {
        const email = document.getElementById("newEmail").value.trim();

        if (!email) {
          showStatus("Please enter an email address", "error", "addSubscriber");
          return;
        }

        if (!isValidEmail(email)) {
          showStatus(
            "Please enter a valid email address",
            "error",
            "addSubscriber"
          );
          return;
        }

        try {
          showStatus("Adding subscriber...", "info", "addSubscriber");

          const response = await fetch(
            `${WEB_APP_URL}?email=${encodeURIComponent(email)}&source=admin`
          );
          const result = await response.json();

          if (result.success) {
            showStatus(
              "Subscriber added successfully!",
              "success",
              "addSubscriber"
            );
            document.getElementById("newEmail").value = "";
            loadSubscribers(); // Refresh the list
          } else {
            showStatus(`${result.message}`, "error", "addSubscriber");
          }
        } catch (error) {
          console.error("Error adding subscriber:", error);
          showStatus(
            "Error adding subscriber. Please try again.",
            "error",
            "addSubscriber"
          );
        }
      }

      // ==================== SUBSCRIBER SELECTION ====================
      function selectAll() {
        document
          .querySelectorAll(".subscriber-checkbox")
          .forEach((checkbox) => {
            checkbox.checked = true;
          });
        updateSelectedCount();
      }

      function deselectAll() {
        document
          .querySelectorAll(".subscriber-checkbox")
          .forEach((checkbox) => {
            checkbox.checked = false;
          });
        updateSelectedCount();
      }

      function updateSelectedCount() {
        const selectedCount = document.querySelectorAll(
          ".subscriber-checkbox:checked"
        ).length;
        document.getElementById("selectedCount").textContent = selectedCount;
      }

      function selectBySource(source) {
        document
          .querySelectorAll(".subscriber-checkbox")
          .forEach((checkbox, index) => {
            const subscriber = subscribers[index];
            const subscriberSource =
              subscriber.Source || subscriber.source || "website";
            checkbox.checked =
              subscriberSource.toLowerCase() === source.toLowerCase();
          });
        updateSelectedCount();
      }

      // ==================== FILE ATTACHMENT HANDLING ====================
      function handleAttachments(input) {
        const files = Array.from(input.files);
        const maxSize = 5 * 1024 * 1024; // 5MB per file
        const allowedTypes = [
          "application/pdf",
          "application/msword",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          "text/plain",
          "image/jpeg",
          "image/jpg",
          "image/png",
          "image/gif",
        ];

        files.forEach((file) => {
          // Check file size
          if (file.size > maxSize) {
            showStatus(
              `File "${file.name}" is too large. Maximum size is 5MB.`,
              "error",
              "general"
            );
            return;
          }

          // Check file type
          if (!allowedTypes.includes(file.type)) {
            showStatus(
              `File type not supported for "${file.name}". Please use PDF, DOC, DOCX, TXT, or image files.`,
              "error",
              "general"
            );
            return;
          }

          // Check if file already exists
          const existingFile = attachedFiles.find(
            (f) => f.name === file.name && f.size === file.size
          );
          if (existingFile) {
            showStatus(
              `File "${file.name}" is already attached.`,
              "warning",
              "general"
            );
            return;
          }

          // Add file to attachments
          attachedFiles.push(file);
        });

        // Update display
        displayAttachments();
        updateEmailPreview();

        // Clear input to allow re-selecting the same file if needed
        input.value = "";
      }

      function displayAttachments() {
        const attachmentList = document.getElementById("attachmentList");

        if (attachedFiles.length === 0) {
          attachmentList.innerHTML = "";
          return;
        }

        let html =
          '<div style="margin-top: 10px;"><strong>Attached Files:</strong></div>';

        attachedFiles.forEach((file, index) => {
          const fileSize = formatFileSize(file.size);
          const fileIcon = getFileIcon(file.type);

          html += `
      <div class="attachment-item">
        <div class="attachment-name">
          <span class="file-icon">${fileIcon}</span>
          <span>${file.name}</span>
          <span class="attachment-size">(${fileSize})</span>
        </div>
        <button class="attachment-remove" onclick="removeAttachment(${index})" title="Remove file">
          ×
        </button>
      </div>
    `;
        });

        attachmentList.innerHTML = html;
      }

      function removeAttachment(index) {
        attachedFiles.splice(index, 1);
        displayAttachments();
        updateEmailPreview();
        showStatus("File removed from attachments", "info", "general");
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function getFileIcon(fileType) {
        const icons = {
          "application/pdf": "📄",
          "application/msword": "📝",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            "📝",
          "text/plain": "📄",
          "image/jpeg": "🖼️",
          "image/jpg": "🖼️",
          "image/png": "🖼️",
          "image/gif": "🖼️",
        };
        return icons[fileType] || "📎";
      }

      async function convertFilesToBase64() {
        const filePromises = attachedFiles.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              resolve({
                name: file.name,
                type: file.type,
                size: file.size,
                data: reader.result.split(",")[1], // Remove data:type;base64, prefix
              });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        });

        try {
          return await Promise.all(filePromises);
        } catch (error) {
          console.error("Error converting files to base64:", error);
          throw new Error("Failed to process attachments");
        }
      }

      // ==================== DRAG AND DROP ====================
      function initializeDragAndDrop() {
        const attachmentContainer = document.querySelector(
          ".attachment-container"
        );

        if (!attachmentContainer) return;

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          attachmentContainer.addEventListener(
            eventName,
            preventDefaults,
            false
          );
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          attachmentContainer.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          attachmentContainer.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          attachmentContainer.style.borderColor = "#667eea";
          attachmentContainer.style.background = "#f0f2ff";
        }

        function unhighlight() {
          attachmentContainer.style.borderColor = "#e9ecef";
          attachmentContainer.style.background = "#f8f9fa";
        }

        attachmentContainer.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          // Simulate file input change
          const fileInput = document.getElementById("emailAttachments");
          if (fileInput) {
            fileInput.files = files;
            handleAttachments(fileInput);
          }
        }
      }

      // ==================== NEWSLETTER SENDING ====================
      async function sendNewsletter() {
        const subject = document.getElementById("emailSubject").value.trim();
        const body = document.getElementById("emailBody").value.trim();
        const selectedCheckboxes = document.querySelectorAll(
          ".subscriber-checkbox:checked"
        );

        // Validation
        if (!subject) {
          showStatus("Please enter a subject line", "error", "send");
          return;
        }

        if (!body) {
          showStatus("Please enter email content", "error", "send");
          return;
        }

        if (selectedCheckboxes.length === 0) {
          showStatus("Please select at least one recipient", "error", "send");
          return;
        }

        // Check attachment size limit
        const totalSize = attachedFiles.reduce(
          (sum, file) => sum + file.size,
          0
        );
        const maxTotalSize = 25 * 1024 * 1024; // 25MB total limit

        if (totalSize > maxTotalSize) {
          showStatus(
            "Total attachment size exceeds 25MB limit. Please remove some files.",
            "error",
            "send"
          );
          return;
        }

        // Confirm before sending
        const attachmentText =
          attachedFiles.length > 0
            ? ` with ${attachedFiles.length} attachment(s)`
            : "";

        if (
          !confirm(
            `Send newsletter to ${selectedCheckboxes.length} recipients${attachmentText}?`
          )
        ) {
          return;
        }

        // Get selected recipients
        const selectedEmails = [];
        selectedCheckboxes.forEach((checkbox) => {
          const index = parseInt(checkbox.id.replace("sub_", ""));
          const email = subscribers[index].email || subscribers[index].Email;
          if (email) selectedEmails.push(email);
        });

        try {
          const sendBtn = document.querySelector(".send-btn");
          sendBtn.disabled = true;
          sendBtn.innerHTML = "Preparing...";

          // Convert attachments to base64 if any exist
          let attachments = [];
          if (attachedFiles.length > 0) {
            sendBtn.innerHTML = "Processing attachments...";
            showStatus("Processing attachments...", "info", "send");
            attachments = await convertFilesToBase64();
          }

          sendBtn.innerHTML = "Sending...";

          const newsletterData = {
            action: "send_newsletter",
            subject: subject,
            body: body,
            recipients: selectedEmails,
            attachments: attachments,
          };

          showStatus(
            `Sending newsletter to ${selectedEmails.length} recipients${attachmentText}...`,
            "info",
            "send"
          );

          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newsletterData),
          });

          // Handle the response
          let result;
          try {
            const responseText = await response.text();
            if (responseText) {
              result = JSON.parse(responseText);
            } else {
              result = {
                success: true,
                message: `Newsletter sent to ${selectedEmails.length} recipients${attachmentText}`,
              };
            }
          } catch (parseError) {
            result = {
              success: true,
              message: `Newsletter sent to ${selectedEmails.length} recipients${attachmentText}`,
            };
          }

          if (result.success) {
            showStatus(
              `Newsletter sent successfully to ${selectedEmails.length} recipients${attachmentText}!`,
              "success",
              "send"
            );

            // Reset form including attachments
            document.getElementById("emailSubject").value = "";
            document.getElementById("emailBody").value = "";
            attachedFiles = [];
            displayAttachments();
            updateEmailPreview();
            deselectAll();
            clearDraft();

            // Update stats
            const currentCount =
              parseInt(
                document.getElementById("newslettersSent").textContent
              ) || 0;
            document.getElementById("newslettersSent").textContent =
              currentCount + 1;

            setTimeout(() => {
              loadHistory();
            }, 2000);
          } else {
            showStatus(`Error: ${result.message}`, "error", "send");
          }
        } catch (error) {
          console.error("Error sending newsletter:", error);

          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("CORS")
          ) {
            showStatus(
              `Newsletter likely sent successfully (CORS restriction prevents confirmation). Check your email and history tab.`,
              "info",
              "send"
            );

            // Reset form optimistically
            document.getElementById("emailSubject").value = "";
            document.getElementById("emailBody").value = "";
            attachedFiles = [];
            displayAttachments();
            updateEmailPreview();
            deselectAll();
            clearDraft();

            setTimeout(() => {
              loadHistory();
            }, 3000);
          } else {
            showStatus(
              "Error sending newsletter. Please try again.",
              "error",
              "send"
            );
          }
        } finally {
          const sendBtn = document.querySelector(".send-btn");
          sendBtn.disabled = false;
          sendBtn.innerHTML = "Send Newsletter";
        }
      }

      // ==================== NEWSLETTER HISTORY ====================
      async function loadHistory() {
        try {
          showStatus("Loading newsletter history...", "info", "history");

          const response = await fetch(`${WEB_APP_URL}?action=get_history`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.success === false) {
            throw new Error(data.message || "Failed to load history");
          }

          // Handle different response formats
          if (data.history) {
            newsletterHistory = Array.isArray(data.history) ? data.history : [];
          } else if (Array.isArray(data)) {
            newsletterHistory = data;
          } else {
            newsletterHistory = [];
          }

          displayHistory();
          showStatus(
            `Loaded ${newsletterHistory.length} newsletter records`,
            "success",
            "history"
          );
        } catch (error) {
          console.error("Error loading history:", error);
          showStatus(
            `Error loading history: ${error.message}`,
            "error",
            "history"
          );
          newsletterHistory = [];
          displayHistory();
        }
      }

      function displayHistory() {
        const container = document.getElementById("historyContainer");

        if (!newsletterHistory || newsletterHistory.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; color: #6c757d; padding: 40px;">No newsletter history found. Send your first newsletter to see records here!</div>';
          return;
        }

        let tableHtml = `
    <table class="history-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Subject</th>
          <th>Recipients</th>
          <th>Attachments</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

        newsletterHistory.forEach((newsletter, index) => {
          const date =
            newsletter.date || newsletter.Sent_Date
              ? new Date(
                  newsletter.date || newsletter.Sent_Date
                ).toLocaleDateString()
              : "N/A";
          const subject =
            newsletter.subject || newsletter.Subject || "No Subject";
          const recipients =
            newsletter.recipients || newsletter.Recipient_Count || 0;
          const attachmentCount = newsletter.attachments
            ? newsletter.attachments.length
            : 0;
          const status = newsletter.status || "Sent";

          tableHtml += `
      <tr>
        <td>${date}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${subject}">${subject}</td>
        <td>${recipients}</td>
        <td>${attachmentCount > 0 ? `📎 ${attachmentCount}` : "-"}</td>
        <td><span style="color: #4caf50; font-weight: 600;">${status}</span></td>
        <td>
          <button class="btn btn-secondary" onclick="viewNewsletter(${index})" style="padding: 5px 10px; font-size: 12px;">
            View
          </button>
        </td>
      </tr>
    `;
        });

        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      function viewNewsletter(index) {
        const newsletter = newsletterHistory[index];
        if (!newsletter) return;

        const subject =
          newsletter.subject || newsletter.Subject || "No Subject";
        const body =
          newsletter.body || newsletter.Body || "No content available";
        const recipients =
          newsletter.recipients || newsletter.Recipient_Count || 0;
        const date =
          newsletter.date || newsletter.Sent_Date
            ? new Date(newsletter.date || newsletter.Sent_Date).toLocaleString()
            : "N/A";
        const attachments = newsletter.attachments || [];

        // Create a modal-like display
        const modal = document.createElement("div");
        modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
    align-items: center; justify-content: center;
  `;

        const content = document.createElement("div");
        content.style.cssText = `
    background: white; max-width: 600px; max-height: 80vh; overflow-y: auto;
    padding: 30px; border-radius: 10px; position: relative;
  `;

        let attachmentHtml = "";
        if (attachments.length > 0) {
          attachmentHtml = `
      <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
        <strong>Attachments (${attachments.length}):</strong>
        <ul style="margin-top: 10px;">
          ${attachments
            .map(
              (att) =>
                `<li>${att.name || "Unknown"} (${formatFileSize(
                  att.size || 0
                )})</li>`
            )
            .join("")}
        </ul>
      </div>
    `;
        }

        content.innerHTML = `
    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
            style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
    <h3 style="color: #2c3e50; margin-bottom: 20px;">Newsletter Details</h3>
    <div style="margin-bottom: 15px;"><strong>Subject:</strong> ${subject}</div>
    <div style="margin-bottom: 15px;"><strong>Recipients:</strong> ${recipients}</div>
    <div style="margin-bottom: 20px;"><strong>Date:</strong> ${date}</div>
    ${attachmentHtml}
    <div style="border-top: 1px solid #eee; padding-top: 20px;">
      <strong>Content:</strong>
      <div style="margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; line-height: 1.6;">${body}</div>
    </div>
  `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Close on background click
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // ==================== UTILITY FUNCTIONS ====================
      function updateStats() {
        document.getElementById("totalSubscribers").textContent =
          subscribers.length;
        updateSelectedCount();
      }

      function showStatus(message, type = "info", target = "general") {
        let statusElement;

        switch (target) {
          case "send":
            statusElement = document.getElementById("sendStatus");
            break;
          case "addSubscriber":
            statusElement = document.getElementById("addSubscriberStatus");
            break;
          case "history":
            statusElement = document.createElement("div");
            statusElement.className = "status-message";
            const historyContainer =
              document.getElementById("historyContainer");
            historyContainer.insertBefore(
              statusElement,
              historyContainer.firstChild
            );
            break;
          default:
            statusElement = document.createElement("div");
            statusElement.className = "status-message";
            statusElement.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
            document.body.appendChild(statusElement);
        }

        if (!statusElement) return;

        statusElement.className = `status-message status-${type}`;
        statusElement.textContent = message;
        statusElement.style.display = "block";

        // Auto-hide after appropriate time
        const hideTime =
          target === "general" || target === "history" ? 5000 : 10000;
        setTimeout(() => {
          if (statusElement && statusElement.parentNode) {
            if (target === "general" || target === "history") {
              statusElement.parentNode.removeChild(statusElement);
            } else {
              statusElement.textContent = "";
              statusElement.style.display = "none";
            }
          }
        }, hideTime);
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // ==================== EXPORT FUNCTIONALITY ====================
      function exportSubscribers() {
        if (subscribers.length === 0) {
          showStatus("No subscribers to export", "error", "general");
          return;
        }

        const headers = ["Email", "Date Joined", "Source"];
        let csvContent = headers.join(",") + "\n";

        subscribers.forEach((subscriber) => {
          const email = subscriber.email || subscriber.Email || "";
          const date = subscriber.Date
            ? new Date(subscriber.Date).toLocaleDateString()
            : "";
          const source = subscriber.Source || subscriber.source || "website";

          const row = [
            `"${email.replace(/"/g, '""')}"`,
            `"${date}"`,
            `"${source}"`,
          ].join(",");

          csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `newsletter_subscribers_${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showStatus("Subscribers exported successfully!", "success", "general");
      }

      // ==================== DRAFT FUNCTIONALITY ====================
      function setupAutoSave() {
        const subjectField = document.getElementById("emailSubject");
        const bodyField = document.getElementById("emailBody");

        if (subjectField && bodyField) {
          const autoSave = () => {
            const draft = {
              subject: subjectField.value,
              body: bodyField.value,
              attachments: attachedFiles.map((f) => ({
                name: f.name,
                size: f.size,
                type: f.type,
              })),
              timestamp: new Date().toISOString(),
            };
            window.draftData = draft;
          };

          subjectField.addEventListener("input", autoSave);
          bodyField.addEventListener("input", autoSave);
          setInterval(autoSave, 30000);
        }
      }

      function loadDraft() {
        if (window.draftData) {
          const draft = window.draftData;
          document.getElementById("emailSubject").value = draft.subject || "";
          document.getElementById("emailBody").value = draft.body || "";
          updateEmailPreview();
        }
      }

      function clearDraft() {
        window.draftData = null;
      }

      // ==================== TEMPLATE FUNCTIONALITY (CONTINUED) ====================
      const emailTemplates = {
        welcome: {
          subject: "Welcome to our Newsletter!",
          body: "Thank you for subscribing to our newsletter. We're excited to share valuable content with you!",
        },
        announcement: {
          subject: "Important Announcement",
          body: "We have some exciting news to share with you...",
        },
        newsletter: {
          subject: "Monthly Newsletter - [Month Year]",
          body: "Dear Subscriber,\n\nHere's what's happening this month:\n\n• [Topic 1]\n• [Topic 2]\n• [Topic 3]\n\nBest regards,\nYour Team",
        },
        promotion: {
          subject: "Special Offer Just for You!",
          body: "We have an exclusive offer for our newsletter subscribers:\n\n[Offer Details]\n\nDon't miss out - this offer expires soon!\n\nBest regards,\nYour Team",
        },
        event: {
          subject: "Upcoming Event - Save the Date!",
          body: "You're invited to our upcoming event:\n\n[Event Name]\nDate: [Date]\nTime: [Time]\nLocation: [Location]\n\nWe hope to see you there!\n\nBest regards,\nYour Team",
        },
      };

      function addTemplateButtons() {
        const composeTab = document.getElementById("compose");
        if (!composeTab) return;

        // Check if template container already exists
        if (document.querySelector(".template-container")) return;

        const templateContainer = document.createElement("div");
        templateContainer.className = "template-container";
        templateContainer.style.cssText = `
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  `;

        templateContainer.innerHTML = `
    <div style="margin-bottom: 10px; font-weight: 600; color: #495057;">Quick Templates:</div>
    <div class="template-buttons" style="display: flex; flex-wrap: wrap; gap: 8px;">
      ${Object.keys(emailTemplates)
        .map(
          (key) =>
            `<button class="template-btn" onclick="loadTemplate('${key}')" 
         style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;">
         ${key.charAt(0).toUpperCase() + key.slice(1)}
         </button>`
        )
        .join("")}
    </div>
  `;

        // Insert at the beginning of the compose section, not before the subject field
        const sectionTitle = composeTab.querySelector(".section");
        if (sectionTitle) {
          sectionTitle.insertBefore(
            templateContainer,
            sectionTitle.querySelector(".form-group")
          );
        }

        // Add hover effects
        templateContainer.querySelectorAll(".template-btn").forEach((btn) => {
          btn.addEventListener("mouseenter", function () {
            this.style.backgroundColor = "#0056b3";
          });
          btn.addEventListener("mouseleave", function () {
            this.style.backgroundColor = "#007bff";
          });
        });
      }

      function loadTemplate(templateKey) {
        const template = emailTemplates[templateKey];
        if (!template) return;

        const subjectField = document.getElementById("emailSubject");
        const bodyField = document.getElementById("emailBody");

        if (subjectField && bodyField) {
          subjectField.value = template.subject;
          bodyField.value = template.body;
          updateEmailPreview();
          showStatus(
            `Template "${templateKey}" loaded successfully!`,
            "success",
            "general"
          );
        }
      }

      // ==================== CHARACTER COUNTS ====================
      function addCharacterCounts() {
        const subjectField = document.getElementById("emailSubject");
        const bodyField = document.getElementById("emailBody");

        if (subjectField) {
          // Check if counter already exists
          if (!document.getElementById("subjectCounter")) {
            const subjectCounter = document.createElement("div");
            subjectCounter.id = "subjectCounter";
            subjectCounter.style.cssText = `
        font-size: 12px; 
        color: #6c757d; 
        text-align: right; 
        margin-top: 5px;
      `;

            // Insert after the subject field's parent form-group
            const formGroup = subjectField.closest(".form-group");
            if (formGroup) {
              formGroup.appendChild(subjectCounter);
            }
          }
        }

        if (bodyField) {
          // Check if counter already exists
          if (!document.getElementById("bodyCounter")) {
            const bodyCounter = document.createElement("div");
            bodyCounter.id = "bodyCounter";
            bodyCounter.style.cssText = `
        font-size: 12px; 
        color: #6c757d; 
        text-align: right; 
        margin-top: 5px;
      `;

            // Insert after the body field's parent form-group
            const formGroup = bodyField.closest(".form-group");
            if (formGroup) {
              formGroup.appendChild(bodyCounter);
            }
          }
        }

        // Add event listeners if they don't already exist
        if (subjectField && !subjectField.hasAttribute("data-counter-added")) {
          subjectField.addEventListener("input", updateCharacterCounts);
          subjectField.setAttribute("data-counter-added", "true");
        }

        if (bodyField && !bodyField.hasAttribute("data-counter-added")) {
          bodyField.addEventListener("input", updateCharacterCounts);
          bodyField.setAttribute("data-counter-added", "true");
        }

        // Initial count update
        updateCharacterCounts();
      }

      function updateCharacterCounts() {
        const subjectField = document.getElementById("emailSubject");
        const bodyField = document.getElementById("emailBody");
        const subjectCounter = document.getElementById("subjectCounter");
        const bodyCounter = document.getElementById("bodyCounter");

        if (subjectField && subjectCounter) {
          const subjectLength = subjectField.value.length;
          const subjectColor = subjectLength > 60 ? "#dc3545" : "#6c757d";
          subjectCounter.innerHTML = `<span style="color: ${subjectColor}">${subjectLength} characters (recommended: under 60)</span>`;
        }

        if (bodyField && bodyCounter) {
          const bodyLength = bodyField.value.length;
          const wordCount = bodyField.value.trim()
            ? bodyField.value.trim().split(/\s+/).length
            : 0;
          bodyCounter.innerHTML = `${bodyLength} characters | ${wordCount} words`;
        }
      }

      // ==================== SUBSCRIBER SEARCH (FIXED) ====================
      function addSubscriberSearch() {
        const subscriberTabs = ["subscribers", "compose"];

        subscriberTabs.forEach((tabName) => {
          const tab = document.getElementById(tabName);
          if (!tab) return;

          // Check if search container already exists
          const existingSearch = tab.querySelector(".search-container");
          if (existingSearch) return;

          const searchContainer = document.createElement("div");
          searchContainer.className = "search-container";
          searchContainer.style.cssText = `
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    `;

          const searchId = `${tabName}Search`;
          searchContainer.innerHTML = `
      <div style="margin-bottom: 10px; font-weight: 600; color: #495057;">Search Subscribers:</div>
      <input type="text" id="${searchId}" placeholder="Search by email or source..." 
             style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;"
             onkeyup="filterSubscribers('${tabName}')">
      <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
        <span id="${tabName}SearchResults"></span>
      </div>
    `;

          // Find the correct insertion point
          const sectionTitle = tab.querySelector(".section");
          const subscriberControls = tab.querySelector(".subscriber-controls");

          if (sectionTitle && subscriberControls) {
            sectionTitle.insertBefore(searchContainer, subscriberControls);
          }
        });
      }
      function filterSubscribers(tabName) {
        const searchInput = document.getElementById(`${tabName}Search`);
        const resultsSpan = document.getElementById(`${tabName}SearchResults`);

        if (!searchInput || !resultsSpan) return;

        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          // Show all subscribers
          if (tabName === "subscribers") {
            displaySubscribers();
          } else {
            displaySubscribersForCompose();
          }
          resultsSpan.textContent = "";
          return;
        }

        const filteredSubscribers = subscribers.filter((subscriber) => {
          const email = (
            subscriber.email ||
            subscriber.Email ||
            ""
          ).toLowerCase();
          const source = (
            subscriber.Source ||
            subscriber.source ||
            "website"
          ).toLowerCase();
          return email.includes(searchTerm) || source.includes(searchTerm);
        });

        // Display filtered results
        displayFilteredSubscribers(filteredSubscribers, tabName);

        const resultText =
          filteredSubscribers.length === 1
            ? "1 subscriber found"
            : `${filteredSubscribers.length} subscribers found`;
        resultsSpan.textContent = resultText;
      }

      function displayFilteredSubscribers(filteredSubscribers, tabName) {
        const listContainer =
          tabName === "subscribers"
            ? document.getElementById("subscriberList")
            : document.getElementById("composeSubscriberList");

        if (!listContainer) return;

        if (filteredSubscribers.length === 0) {
          listContainer.innerHTML =
            '<div style="text-align: center; color: #6c757d; padding: 40px;">No subscribers found matching your search.</div>';
          return;
        }

        listContainer.innerHTML = "";

        filteredSubscribers.forEach((subscriber, index) => {
          const item = document.createElement("div");
          item.className = "subscriber-item";

          const email = subscriber.email || subscriber.Email || "Unknown";
          const date = subscriber.Date
            ? new Date(subscriber.Date).toLocaleDateString()
            : "N/A";
          const source = subscriber.Source || subscriber.source || "website";

          if (tabName === "compose") {
            // Find original index for checkbox functionality
            const originalIndex = subscribers.findIndex(
              (s) =>
                (s.email || s.Email) === (subscriber.email || subscriber.Email)
            );

            item.innerHTML = `
        <input type="checkbox" class="subscriber-checkbox" id="sub_${originalIndex}" 
               onchange="updateSelectedCount()">
        <label for="sub_${originalIndex}" class="subscriber-email">${email}</label>
        <div class="subscriber-meta">
          <div class="subscriber-date">${date}</div>
          <div class="subscriber-source">${source}</div>
        </div>
      `;
          } else {
            item.innerHTML = `
        <div class="subscriber-email">${email}</div>
        <div class="subscriber-meta">
          <div class="subscriber-date">Joined: ${date}</div>
          <div class="subscriber-source">${source}</div>
        </div>
      `;
          }

          listContainer.appendChild(item);
        });
      }

      // ==================== ADDITIONAL UTILITY FUNCTIONS ====================
      function refreshData() {
        showStatus("Refreshing data...", "info", "general");
        loadSubscribers();
        loadHistory();
      }

      function clearForm() {
        if (
          confirm(
            "Are you sure you want to clear the form? Any unsaved content will be lost."
          )
        ) {
          document.getElementById("emailSubject").value = "";
          document.getElementById("emailBody").value = "";
          attachedFiles = [];
          displayAttachments();
          updateEmailPreview();
          updateCharacterCounts();
          clearDraft();
          showStatus("Form cleared successfully", "info", "general");
        }
      }

      // ==================== KEYBOARD SHORTCUTS ====================
      document.addEventListener("keydown", function (e) {
        // Ctrl/Cmd + S to save draft
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          const draft = {
            subject: document.getElementById("emailSubject").value,
            body: document.getElementById("emailBody").value,
            timestamp: new Date().toISOString(),
          };
          window.draftData = draft;
          showStatus("Draft saved", "success", "general");
        }

        // Ctrl/Cmd + Enter to send (when in compose tab)
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          const composeTab = document.getElementById("compose");
          if (composeTab && composeTab.classList.contains("active")) {
            sendNewsletter();
          }
        }
      });

      // ==================== ERROR HANDLING AND VALIDATION ====================
      function validateConfiguration() {
        if (!WEB_APP_URL || WEB_APP_URL === "YOUR_WEB_APP_URL_HERE") {
          showStatus(
            "Please configure your Google Apps Script Web App URL in the code",
            "error",
            "general"
          );
          return false;
        }
        return true;
      }

      // ==================== ENHANCED STATISTICS ====================
      function updateEnhancedStats() {
        const stats = {
          total: subscribers.length,
          thisWeek: 0,
          thisMonth: 0,
          bySource: {},
        };

        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        subscribers.forEach((subscriber) => {
          const joinDate = subscriber.Date ? new Date(subscriber.Date) : null;
          const source = subscriber.Source || subscriber.source || "website";

          if (joinDate) {
            if (joinDate >= weekAgo) stats.thisWeek++;
            if (joinDate >= monthAgo) stats.thisMonth++;
          }

          stats.bySource[source] = (stats.bySource[source] || 0) + 1;
        });

        // Update main stats
        document.getElementById("totalSubscribers").textContent = stats.total;

        // Add additional stats if elements exist
        const weeklyStats = document.getElementById("weeklySubscribers");
        const monthlyStats = document.getElementById("monthlySubscribers");

        if (weeklyStats) weeklyStats.textContent = stats.thisWeek;
        if (monthlyStats) monthlyStats.textContent = stats.thisMonth;

        updateSelectedCount();
      }

      // ==================== INITIALIZATION ENHANCEMENTS ====================
      // Override the original initialization to include validation
      const originalDOMContentLoaded = document.addEventListener;
      document.addEventListener("DOMContentLoaded", function () {
        // Validate configuration first
        if (!validateConfiguration()) {
          return;
        }

        // Load all content on page load
        loadSubscribers();
        loadHistory();

        // Setup email preview
        document
          .getElementById("emailBody")
          .addEventListener("input", updateEmailPreview);
        document
          .getElementById("emailSubject")
          .addEventListener("input", updateEmailPreview);

        // Set initial newsletter count
        document.getElementById("newslettersSent").textContent = "0";
        setupAutoSave();
        loadDraft();

        // Initialize enhanced features with delay to ensure DOM is ready
        setTimeout(() => {
          addTemplateButtons();
          addCharacterCounts();
          addSubscriberSearch();
          initializeDragAndDrop();
        }, 500);

        // Add refresh button functionality if it exists
        const refreshBtn = document.getElementById("refreshBtn");
        if (refreshBtn) {
          refreshBtn.addEventListener("click", refreshData);
        }

        // Add clear form button functionality if it exists
        const clearBtn = document.getElementById("clearBtn");
        if (clearBtn) {
          clearBtn.addEventListener("click", clearForm);
        }

        showStatus(
          "Newsletter Manager initialized successfully!",
          "success",
          "general"
        );
      });

      // ==================== FINAL EXPORTS AND UTILITIES ====================
      // Make functions available globally for onclick handlers
      window.switchTab = switchTab;
      window.selectAll = selectAll;
      window.deselectAll = deselectAll;
      window.selectBySource = selectBySource;
      window.updateSelectedCount = updateSelectedCount;
      window.addSubscriber = addSubscriber;
      window.sendNewsletter = sendNewsletter;
      window.exportSubscribers = exportSubscribers;
      window.handleAttachments = handleAttachments;
      window.removeAttachment = removeAttachment;
      window.loadTemplate = loadTemplate;
      window.filterSubscribers = filterSubscribers;
      window.viewNewsletter = viewNewsletter;
      window.refreshData = refreshData;
      window.clearForm = clearForm;

      console.log(
        "Newsletter Manager v2.0 - Fully loaded with enhanced features!"
      );
    </script>
  </body>
</html>
